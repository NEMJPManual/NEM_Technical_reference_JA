## サンプルの収集

ネットワーク内の各ノードは、開始時に０に設定されるオフセットと呼ばれる整数値を管理します。
オフセット（負でありうる）で増加するミリ秒単位のローカルシステム時間はノードのネットワーク時間（これもミリ秒単位）です。


ノードの起動が完了した後、ノード（以下、ローカルノード）は時間同期ラウンドを実行するため、最大20のパートナーノード
選択します。最低限の重要度を持つノードのみがパートナーとみなされます。


<img src="/images/Figure13.png">
<center>図13:ローカルノードとパートナーノードの通信</center>
<br>


すべての選択されたパートナーに対して、ローカルノードは、パートナーに現在のネットワーク時間を尋ねる要求を送信します。
ローカルノードは、要求を送信し応答を受信したとき、ネットワークタイムスタンプを記憶します。
各パートナーノードは、要求の到着のタイムスタンプと応答のタイムスタンプを含むサンプルで応答します。
パートナーノードは、独自のネットワーク時間を使用してタイムスタンプを作成します。
[図13](#図13)は、ノード間の通信を示しています。

ローカルノードは、タイムスタンプを使用して、ラウンドトリップ時間が計算できます。

$$
rtt=(t_4-t_1)-(t_3-t_2)
$$

そして、2つのノードによって使用されるネットワーク時間の間のオフセットを以下のように推定します。

$$
o=t_2-t_1-\frac{rtt}{2}
$$

ローカルノードにオフセット見積りのリストができるまで、これを同期パートナーごとに繰り返します。

