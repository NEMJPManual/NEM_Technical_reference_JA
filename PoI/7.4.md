## トランザクショングラフのクラスタリング

SCAN[16](/References#16.md)と呼ばれる既存のハイパフォーマンスなグラフクラスタリングアルゴリズムの実装が存在し[13](/References.md#13)[^5]、これがトランザクションのグラフに対して実行されます。
この実装ではコアとなるノードをまず決めて、そこから互いに二次の距離にあるノード間の構造的類似度に基いてクラスタを拡張していく仕組みを取っています。
以下にアルゴリズムの詳細を述べます。

アカウントの集合$$V$$をノード、アカウント間の1000XEM以上の送金トランザクションに前述の重みを付けたもの（[7.2節: アウトリンク行列](/PoI/7.2.md)を参照）をエッジ$$E$$とし、$$V$$と$$E$$からなるグラフを$$G$$とします。
トランザクショングラフ$$G$$を構成するアカウントを構造的類似度に基いてクラスタリングすることで、クラスタ、ハブ、外れ値を検出することができます。
アカウント$$u$$とアカウント$$v$$間の構造的類似度$$\sigma(u,v)$$は以下の式で求まります。

$$
\sigma(u,v) = \frac{|\Gamma(u)\cap\Gamma(v)|}{\sqrt{|\Gamma(u)||\Gamma(v)|}}
$$

ここで$$|.|$$はグラフの濃度(cardinality)（訳注: ノードの数）で、$$\Gamma(u)$$は$$u$$自身を含む構造的隣接ノード集合で、以下のように定義されます。

$$
\Gamma(u) = {v \in V | {u,v} \in E} \cup {u}.
$$

$$N_{\epsilon}$$は、所与の閾値$$\epsilon$$に基いて選ばれた、構造的類似性を持つアカウントの集合です。以下のように定義されます。

$$
N_{\epsilon}{u} = {v \in \Gamma(u) | \sigma(u,v) \geq \epsilon}.
$$

コアノードは軸としてクラスタを拡張していくのに用いられ、以下のように定義されます。

$$
K_{\epsilon,\mu} \Longleftrightarrow |N_{\epsilon}(u)| \geq \mu
$$

$$\mu$$は、コアとみなされるのに最低限必要な、条件$$\epsilon$$を満たす近隣のアカウントの数です。クラスタリングの間、コアアカウントを中心(pivot)にクラスタが形成されます。
クラスタの最初のメンバーは$$N_{\epsilon}$$です。これはすなわち$$\mu$$はクラスタの最小サイズをコントロールするものだということです。
NEMでは$$\mu$$は4で$$\epsilon$$は0.3です。
特定の$$\epsilon,\mu$$の元で、$$u$$がコアであり、
$$v$$が$$N_{\epsilon}(u)$$のメンバーであるとき、
「アカウント$$v$$は$$u$$に対して構造的直接到達性(*direct structure reachability*)$$u \mapsto_{\epsilon,\mu} v $$を持つ」と言います


$$
\mu \mapsto_{\epsilon,\mu}v \Longleftrightarrow K_{\epsilon, \mu}(\mu) \land v \in N_{\epsilon}(\mu)
$$

SCANアルゴリズムの場合、 コアとなるアカウントを軸に、構造的直接到達性のあるアカウントを取り込んでいくことでクラスタを形成していきますが、
これには隣接するアカウント（一次の距離）及びそれに隣接するアカウント（二次の距離）との構造的類似度を計算する必要があります。

改良版SCANでは、軸から二次の距離にあるアカウントとの類似度のみを考慮します。
アカウント$$u$$から二次の距離にあるアカウントの集合$$H(u)$$は以下で定義されます。

$$
H(u) = {v \in V|(u, v) \notin E \land (v,w) \in E }
$$

ただしアカウント$$w$$は$$w \in N_{\epsilon}(u) \backslash {u}$$です。
軸から二次の距離にある各コアアカウントに対してクラスタが形成、すなわちコアアカウントの、基準エプシロン($$\epsilon$$)を満たす近隣(epsilon neighbors i.e.  $$(N_{\epsilon})$$)がクラスタに加えられます。
このように、軸から二次の距離にあるアカウントに対して計算を行うときには、軸から構造的直接到達性を持つアカウントは計算対象から除外されます。

考慮対象となる、二次の距離にあるアカウントをどんどん広げていく際には、以下のの定義に基いて判定が行われます。

$$
H(u_n) = \left\{ v \in V|(u,v) \notin E \land v \notin \bigcup_{i=0}^{n-1}N_{\epsilon}(u_i) \cup H(u_i)  \right\}.
$$

全アカウントを処理した後、全ノードを以下に述べる基準に基いてチェックします。

1. アカウントが複数のクラスタに属する場合、そのクラスタを結合する。
2. その後、どのクラスタにも属さないアカウントを調べ、複数のクラスタと結合していればハブ、そうでなければ外れ値と判定する。

構造的類似性$$\sigma$$の計算がアルゴリズム内でもっとも時間のかかるところですので、クラスタの拡張に際して二次の距離にあるアカウントのみを考慮することで計算負荷が減るというのがポイントです。

出力されたクラスタはNCDawareRankのレベル間近似度行列の作成に用いられます。というのも、これがトランザクショングラフのほぼ完全に分解不可能な(nearly completely decomposable)性質を反映するものであるからです。

[^5]: http://db-event.jpn.org/deim2014/final/proceedings/D6-2.pdf
